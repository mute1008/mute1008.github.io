<!doctype html>
<html lang="en"><head>
    <title>論文紹介: REST-ler: Automatic Intelligent REST API Fuzzing</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../../css/theme.css"/>
    
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        src="../../images/avatar.png"
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        Naoya Miyaguchi
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../post/" title="Posts">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../tags/" title="Tags">Tags</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://github.com/mute1997" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">論文紹介: REST-ler: Automatic Intelligent REST API Fuzzing</h3>
            
            <small class="text-muted">Published August 13, 2020</small>
        </div>

        <article>
            <p>fuzzingみたいな感じで脆弱性発見の自動化をWebアプリとかにはうまく適用できないんだろうかと思って調べていた所見つけたのでちょっと読んでみようと思います。</p>
<p>今回はアルゴリズム部分に注目して読んでみます。</p>
<p>この論文ではswaggerの静的分析を行いテストケースを生成しているらしい。</p>
<p>pythonっぽく書かれたアルゴリズムの疑似コードは以下の通り。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Inputs: swaggerspec, maxLength
<span style="color:#75715e"># Swaggerから作成したリクエストの集合</span>
reqSet <span style="color:#f92672">=</span> PROCESS(swaggerspec)
<span style="color:#75715e"># リクエストシーケンスの集合 (最初は空)</span>
seqSet <span style="color:#f92672">=</span> {}
<span style="color:#75715e"># メインループ</span>
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">while</span> (n <span style="color:#f92672">&lt;=</span> maxLength):
  seqSet <span style="color:#f92672">=</span> EXTEND(seqSet, reqSet)
  seqSet <span style="color:#f92672">=</span> RENDER(seqSet)
  n <span style="color:#f92672">=</span> n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>

<span style="color:#75715e"># 依存関係が満たされている新しいリクエストを追加することで、</span>
<span style="color:#75715e"># seqSet内のすべてのシーケンスを拡張する</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">EXTEND</span>(seqSet, reqSet):
  newSeqSet <span style="color:#f92672">=</span> {}
  <span style="color:#66d9ef">for</span> seq <span style="color:#f92672">in</span> seqSet:
    <span style="color:#66d9ef">for</span> req <span style="color:#f92672">in</span> reqSet:
      <span style="color:#66d9ef">if</span> DEPENDENCIES(seq, req):
        newSeqSet <span style="color:#f92672">=</span> newSeqSet <span style="color:#f92672">+</span> concat(seq, req)
  <span style="color:#66d9ef">return</span> newSeqSet

<span style="color:#75715e"># 辞書を利用して新たに追加されたすべてのリクエストを具体化し、</span>
<span style="color:#75715e"># それぞれの新しいリクエストシーケンスを実行し、有効なものを保持する</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">RENDER</span>(seqSet):
  newSeqSet <span style="color:#f92672">=</span> {}
  <span style="color:#66d9ef">for</span> seq <span style="color:#f92672">in</span> seqSet:
    req <span style="color:#f92672">=</span> last_request_in(seq)
    <span style="color:#f92672">~</span>V <span style="color:#f92672">=</span> tuple_of_fuzzable_types_in(req)
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">~</span>v <span style="color:#f92672">in</span> <span style="color:#f92672">~</span>V:
      newReq <span style="color:#f92672">=</span> concretize(req,<span style="color:#f92672">~</span>v)
      newSeq <span style="color:#f92672">=</span> concat(seq, newReq)
      response <span style="color:#f92672">=</span> EXECUTE(newSeq)
      <span style="color:#66d9ef">if</span> response has a valid code:
        newSeqSet <span style="color:#f92672">=</span> newSeqSet <span style="color:#f92672">+</span> newSeq
      <span style="color:#66d9ef">else</span>:
        log error
  <span style="color:#66d9ef">return</span> newSeqSet

<span style="color:#75715e"># リクエストで参照されるすべてのオブジェクトが、</span>
<span style="color:#75715e"># 以前のリクエストシーケンスの何らかのレスポンスによって生成されたものであることをチェックします。</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DEPENDENCIES</span>(seq, req):
  <span style="color:#66d9ef">if</span> CONSUMES(req)<span style="color:#960050;background-color:#1e0010">⊆</span>PRODUCES(seq):
    <span style="color:#66d9ef">return</span> True
  <span style="color:#66d9ef">else</span>:
    <span style="color:#66d9ef">return</span> False

<span style="color:#75715e"># リクエストに必要なオブジェクト</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">CONSUMES</span>(req):
  <span style="color:#66d9ef">return</span> object_types_required_in(req)

<span style="color:#75715e"># 一連のリクエストのレスポンスで生成されたオブジェクト</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">PRODUCES</span>(seq):
  dynamicObjects <span style="color:#f92672">=</span>{}
  <span style="color:#66d9ef">for</span> req <span style="color:#f92672">in</span> seq:
    newObjs <span style="color:#f92672">=</span> objects_produced_in_response_of(req)
    dynamicObjects <span style="color:#f92672">=</span> dynamicObjects <span style="color:#f92672">+</span> newObjs
    <span style="color:#66d9ef">return</span> dynamicObjects
</code></pre></div><p>パパっと見てみると、</p>
<ol>
<li>依存関係がある場合にはseqSetにreqを追加</li>
<li>seqSetの最後のAPIをfuzzing</li>
<li>200が帰ってきたものをseqSetに追加
を繰り返しているっぽい。</li>
</ol>
<p>REST-lerを利用する場合には以下のコードを用いるっぽい。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> restler <span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> restler <span style="color:#f92672">import</span> dependencies

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_posts</span>(data):
  post_id <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;id&#34;</span>]
  dependencies<span style="color:#f92672">.</span>set_var(post_id)

request <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Request(
  restler_static(<span style="color:#e6db74">&#34;POST&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;/api/blog/posts/&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;HTTP/1.1&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;{&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;body&#34;</span>),
  restler_fuzzable(<span style="color:#e6db74">&#34;string&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;POST&#34;</span>),
  restler_static(<span style="color:#e6db74">&#34;{&#34;</span>),
  <span style="color:#e6db74">&#39;post_send&#39;</span>: {
    <span style="color:#e6db74">&#39;parser&#39;</span>: parse_posts,
    <span style="color:#e6db74">&#39;dependencies&#39;</span>: [
      post_id<span style="color:#f92672">.</span>writer(),
    ],
  }
)
</code></pre></div><p>依存関係があるっていうのはどうやって把握してるんだろうと思ってよく読んで見ると, シーケンスの最後に返されたレスポンスを含むリクエストは依存関係があると判断されるらしい。</p>
<p>例えばシーケンスの最後が<code>POST /api/blog/posts</code>とかだとレスポンスにはidが入っている、リクエストボディにidが入っているリクエストは依存関係があると判断されるのかな。</p>
<p>これは実際のコード読んでみないとよくわからないなぁと思って調べていたらソースコードの公開はないらしく、悲しい。</p>
<p><a href="https://twitter.com/vatlidak/status/1097099793514590208?s=21">https://twitter.com/vatlidak/status/1097099793514590208?s=21</a></p>
<p>結果この手法でGitLabのバグを22個発見したということを言っている。</p>
<p>クラッシュのグルーピングや探索方法についても記述があったがそのへんはちゃんと読んでないです。
気になる人は読んでみてください。</p>

        </article>
    </div>

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; Copyright 2020, Naoya Miyaguchi
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
